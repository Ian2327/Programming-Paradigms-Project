{% extends "./base_page.html" %}
{% load filename_filter %}

{% block content %}

<div class="container">
    <div class="login-container">
        <br/>
        <h2 class="text-center mb-4">Edit Listing</h2>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% for field in parentForm %}
            {% if field.name != 'primary_photo' %}
              <div class="mb-3">
                {{ field.label_tag }}
                {{ field }}
                {% if field.errors %}
                  <div class="errorlist">{{ field.errors }}</div>
                {% endif %}
                {% if field.help_text %}
                  <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
              </div>
            {% endif %}
            {% endfor %}

            <div class="mb-3">
                <p>
                    <label for="{{ parentForm.primary_photo.id_for_label }}" class="form-label">{{ parentForm.primary_photo.label }}</label>
                    {% if parentForm.instance.primary_photo %}
                        <a href="{{ parentForm.instance.primary_photo.url }}">{{ parentForm.instance.primary_photo.name|get_filename }}</a><br>
                        Change:
                    {% else %}
                        No image currently uploaded.<br>
                        Upload:
                    {% endif %}
                    {{ parentForm.primary_photo }}
                </p>
                {% if parentForm.primary_photo.errors %}
                    <div class="errorlist">{{ parentForm.primary_photo.errors }}</div>
                {% endif %}
                {% if parentForm.primary_photo.help_text %}
                    <div class="form-text">{{ parentForm.primary_photo.help_text }}</div>
                {% endif %}
            </div>

            {{ factoryForm.management_form }}
            <div id="image-formset-container">
                {% for form in factoryForm %}
                <div class="form-group">
                    {{ form.as_p }}
                </div>
                {% endfor %}
            </div>

            <button type="button" id="add-image-form" class="btn btn-secondary mt-2">Add Another Image</button>
            <button type="submit" class="btn btn-primary">Update Listing</button>
        </form>
        <br/>
    </div>
</div>

<script>
    const imageFormContainer = document.getElementById('image-formset-container');
    const totalForms = document.getElementById('id_image_set-TOTAL_FORMS');
    const addImageButton = document.getElementById('add-image-form');
    let formNum = imageFormContainer.querySelectorAll('.form-group').length;

    function addImageForm() {
        const newForm = document.createElement('div');
        newForm.classList.add('form-group');
        newForm.innerHTML = `
            <p><label for="id_image_set-${formNum}-image">Image:</label> <input type="file" name="image_set-${formNum}-image" id="id_image_set-${formNum}-image" class="form-control"></p>
            <p><label for="id_image_set-${formNum}-DELETE">Delete:</label> <input type="checkbox" name="image_set-${formNum}-DELETE" id="id_image_set-${formNum}-DELETE"></p>
        `;
        imageFormContainer.appendChild(newForm);
        formNum++;
        totalForms.value = formNum;
    }

    addImageButton.addEventListener('click', addImageForm);
</script>

{% endblock %}
{% block currPage %}"sellTab"{% endblock %}